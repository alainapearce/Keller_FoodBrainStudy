#!/bin/tcsh
#
#useage: G4a_clusterize 	$1 			$2
# 						map folder 	level1folder

# The purpose of this script is to clusterize results generated by G1_1sampleT

# Written by Bari Fuchs Fall 2022
###################### set up initial variables  ###########################   
#don't log AFNI programs in ~/.afni.log
setenv AFNI_DONT_LOGFILE YES
 
#dont try version checks
setenv ANFI_VRSION_CHECK NO
 
##don't auto-compress output files
setenv AFNI_COMPRESSOR NONE

###################### setup and check directories  ###########################   
cd ../../../
set bidsdir = "$cwd"

#set test directory
set test_dir = $bidsdir/derivatives/analyses/foodcue-paper1/level2/1sampleT

#set lev1 dir
set lev1_dir = $bidsdir/derivatives/analyses/foodcue-paper1/level1

#set lev2 dir
set lev2_dir = $bidsdir/derivatives/analyses/foodcue-paper1/level2


#set map directory
#set map_dir = $test_dir/$1

# these could be input args
set map_dir = $test_dir/ped_fd-0.9_b20_3runs_noGSR_12-07-22_noclustsim
set lev1_results = ped_fd-0.9_b20_noGSR

if ( ! -d $map_dir ) then
	echo "failed to find $map_dir"
	exit
endif

# Clusterize for each map
set contrasts = ( High-Low_allPS Large-Small_allED Food-Office)
set covariates = (bodyfat mombmi)

foreach contrast ( $contrasts )
		
	# Create bucketfile that contains sub-bricks for each sub
	if ( -f ${map_dir}/${contrast}+tlrc.HEAD ) then
		echo "bucketfile for ${contrast} already exists"
	else
		echo "creating bucketfile for ${contrast}"
		# combine beta weights for each subject into 1 dataset
		foreach sub ( `cat $lev2_dir/index_all_fd-0.9_b20_3runs.txt ` )
			3dbucket -agluteto ${map_dir}/${contrast}+tlrc $lev1_dir/sub-$sub/$lev1_results/stats.sub-$sub+tlrc"[${contrast}_GLT#0_Coef]"
	endif

	foreach covariate ( $covariates )

		# make a maps of clusters that survive cluster thresholding
		3dClusterize 		\
			-nosum 			\
			-1Dformat 		\
			-inset $map_dir/WG_1sampleT++_${contrast}_GLT_${covariate}+tlrc.HEAD \
			-idat 9 -ithr 9 -NN 2 -clust_nvox 300 -bisided -3.2905 3.2905 \
			-pref_map $map_dir/clust_mask-${contrast}_${covariate} \

		if ( -f $map_dir/clust_mask-${contrast}_${covariate}+tlrc.BRIK ) then #if mask was created (only created if there are clusters)
			# extract betas from that mask
			3dROIstats -mask $map_dir/clust_mask-${contrast}_${covariate}+tlrc. ${map_dir}/${contrast}+tlrc > ${map_dir}/clust_betas-${contrast}_${covariate}.txt
		endif
	end
end
