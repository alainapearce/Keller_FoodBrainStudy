#!/bin/tcsh
#
#useage: G4a_clusterize 	$1 	
# 			   level 2 map folder 

# The purpose of this script is to perform cluster extraction for results generated by G1_1sampleT

# Written by Bari Fuchs Fall 2022
###################### set up initial variables  ###########################   
#don't log AFNI programs in ~/.afni.log
setenv AFNI_DONT_LOGFILE YES
 
#dont try version checks
setenv ANFI_VRSION_CHECK NO
 
##don't auto-compress output files
setenv AFNI_COMPRESSOR NONE

###################### setup and check directories  ###########################   
cd ../../../
set bidsdir = "$cwd"

#set lev1 dir
set lev1_dir = $bidsdir/derivatives/analyses/foodcue-paper1/level1

#set lev2 dir
set lev2_dir = $bidsdir/derivatives/analyses/foodcue-paper1/level2

#set map directory
set map_dir = $lev2_dir/1sampleT/$1

#set level1results dir
set mapdir_split = ($1:as/_/ /)
set lev1_results = $mapdir_split[1]_$mapdir_split[2]_$mapdir_split[3]_$mapdir_split[5]
 
if ( ! -d $map_dir ) then
	echo "failed to find $map_dir"
	exit
endif

###################### Generate clusters and extract betas  ###########################


set contrasts = ( High-Low_allPS Large-Small_allED Food-Office)
set covariates = (bodyfat mombmi)

foreach contrast ( $contrasts )
		
	foreach covariate ( $covariates )

		# make a maps of clusters that survive cluster thresholding
		3dClusterize 		\
			-nosum 			\
			-1Dformat 		\
			-inset $map_dir/WG_1sampleT++_${contrast}_GLT_${covariate}+tlrc.HEAD \
			-idat 9 -ithr 9 -NN 2 -clust_nvox 300 -bisided -3.2905 3.2905 \
			-pref_map $map_dir/clust_mask-${contrast}_${covariate} \

		# if map was created (they are only created if there are clusters) 
		if ( -f $map_dir/clust_mask-${contrast}_${covariate}+tlrc.BRIK ) then

			# for each sub, extract average beta from mask and write to .txt file
			foreach sub ( `cat $map_dir/index_all_fd-0.9_b20_3runs.txt ` )
				3dROIstats -mask $map_dir/clust_mask-${contrast}_${covariate}+tlrc. $lev1_dir/sub-$sub/$lev1_results/stats.sub-$sub+tlrc"[${contrast}_GLT#0_Coef]" >> ${map_dir}/clust_betas-${contrast}_${covariate}.txt
		
		endif
	end
end
