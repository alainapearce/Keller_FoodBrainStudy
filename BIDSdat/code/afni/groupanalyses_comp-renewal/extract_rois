#!/bin/tcsh
#
#useage: G4a_clusterize

# The purpose of this script is to perform cluster extraction for results generated by G1_1sampleT

# Written by Bari Fuchs Fall 2022
###################### set up initial variables  ###########################   
#don't log AFNI programs in ~/.afni.log
setenv AFNI_DONT_LOGFILE YES
 
#dont try version checks
setenv ANFI_VRSION_CHECK NO
 
##don't auto-compress output files
setenv AFNI_COMPRESSOR NONE

###################### setup and check directories  ###########################   
cd ../../../
set bidsdir = "$cwd"

#set lev1 dir -- use foodcue-paper2 project folder 
set lev1_dir = $bidsdir/derivatives/analyses/foodcue-paper2/level1

#set lev2 dir -- use foodcue-paper2 project folder 
set lev2_dir = $bidsdir/derivatives/analyses/foodcue-paper2/level2

#set roidir (will also be used as output dir)
set roidir = $bidsdir/derivatives/analyses/comp-renewal/level2/rois

if ( ! -d $roidir ) then
	echo "failed to find $roidir"
	exit
endif

###################### extract betas from combined mask ###########################
## note: all_rois+tlrc is generated by make_rois

## note: can extract from multiple sub-bricks at a time using stats.sub-$sub+tlrc[1,2]

echo "here"
set contrasts = ( Large-Small_allED High-Low_allPS ) 

foreach contrast ( $contrasts )

	# for each sub, extract average beta from mask and write to .txt file
	foreach sub ( `cat $lev2_dir/index_overall_fd-0.9_b20_3runs.txt ` )
		# extract from combined mask
		3dROIstats -mask $roidir/all_rois+tlrc. $lev1_dir/sub-$sub/ped_fd-0.9_b20_noGSR/stats.sub-$sub+tlrc"[${contrast}_GLT#0_Coef]" >> ${roidir}/all_betas-${contrast}.txt
	end
end

